---
import { join } from "node:path";
import { getImage } from "astro:assets";
import type { HTMLAttributes } from "astro/types";
import type { ImageMetadata } from "astro";

interface Props extends HTMLAttributes<"img"> {
  slug?: string;
  name?: string;
  width: number;
  height: number;
  sizes: string;
  class?: string;
}
const { width, height, sizes, name, slug = "default", ...rest } = Astro.props;

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/content/assets/avatars/*.png"
);

const imagePath = `/${join("content", "assets", "avatars")}/${slug}.png`;

if (!images[imagePath]) {
  throw new Error(
    `"${imagePath}" does not exist in glob: "src/assets/avatars/*.png"`
  );
}

const avatarFile = await images[imagePath]();

const widths = [1, 2].map((w) => w * width);

const optimizedImage = await getImage({
  src: avatarFile.default,
  width,
  height,
  sizes,
  format: "avif",
  widths,
  quality: 80,
});
---

<img
  {...rest}
  {...optimizedImage.attributes}
  srcset={optimizedImage.srcSet.attribute}
  alt={name}
/>
